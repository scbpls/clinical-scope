{% extends "base.html" %} {% block title %}ClinicalScope - Statystyki{% endblock
%} {% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.2.0"></script>
{% endblock %} {% block content %}
<section class="section">
  <div class="container">
    <div class="columns mb-0">
      <div class="column is-7">
        <div class="box stat-card">
          <h3 class="title is-6 has-text-centered">
            Dynamika rozpoczętych badań
          </h3>
          <div class="chart-container" style="height: 350px">
            <canvas id="timelineChart"></canvas>
          </div>
          <p class="content is-small has-text-grey has-text-centered mt-2">
            Najedź na punkt, aby zobaczyć podział na typy badań
          </p>
        </div>
      </div>
      <div class="column is-5">
        <div class="box stat-card">
          <h3 class="title is-6 has-text-centered">Liczebność faz badań</h3>
          <div class="chart-container" style="height: 350px">
            <canvas id="phaseChart"></canvas>
          </div>
          <p class="content is-small has-text-grey has-text-centered mt-2">
            Całkowita liczba badań w poszczególnych fazach
          </p>
        </div>
      </div>
    </div>
    <div class="columns mt-0">
      <div class="column is-5">
        <div class="box stat-card">
          <h3 class="title is-6 has-text-centered">Wielkość grup badawczych</h3>
          <div class="chart-container" style="height: 350px">
            <canvas id="enrollmentChart"></canvas>
          </div>
          <p class="content is-small has-text-grey has-text-centered mt-2">
            Podział badań ze względu na liczbę uczestników
          </p>
        </div>
      </div>
      <div class="column is-7">
        <div class="box stat-card">
          <div style="position: relative; margin-bottom: 1rem">
            <button
              class="button is-small is-ghost translate-chart-btn"
              onclick="translateConditions(this)"
              title="Przetłumacz na polski"
              style="
                position: absolute;
                right: 0;
                top: 50%;
                transform: translateY(-50%);
                z-index: 10;
              "
            >
              <span class="icon"><i class="fa-solid fa-language"></i></span>
            </button>
            <h3 class="title is-6 has-text-centered m-0">
              Najczęściej badane schorzenia
            </h3>
          </div>
          <div class="chart-container" style="height: 350px">
            <canvas id="conditionsChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %} {% block scripts %}
<script id="chart-data" type="application/json">
  {
    "timelineLabels": {{ timeline_labels | tojson }},
    "timelineValues": {{ timeline_values | tojson }},
    "timelineDetails": {{ timeline_details | tojson }},
    "phaseLabels": {{ phase_labels | tojson }},
    "phaseValues": {{ phase_values | tojson }},
    "enrollmentLabels": {{ enrollment_labels | tojson }},
    "enrollmentValues": {{ enrollment_values | tojson }},
    "conditionsLabels": {{ conditions_labels | tojson }},
    "conditionsValues": {{ conditions_values | tojson }}
  }
</script>
<script>
  const dataElement = document.getElementById('chart-data');
  const chartData = JSON.parse(dataElement.textContent);

  // 1. Wykres: Dynamika rozpoczętych badań
  new Chart(document.getElementById('timelineChart'), {
    type: 'line',
    data: {
      labels: chartData.timelineLabels,
      datasets: [
        {
          label: 'Łączna liczba badań',
          data: chartData.timelineValues,
          borderColor: getColor('--primary-color'),
          backgroundColor: getColor('--chart-fill-color'),
          fill: true,
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 7,
        },
      ],
    },
    options: {
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true },
        x: {
          grid: { display: false },
          min: '2015',
        },
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            afterBody: function (context) {
              const year = context[0].label;
              const details = chartData.timelineDetails[year];

              if (!details) return [];

              let lines = [];

              for (const [type, count] of Object.entries(details)) {
                if (count > 0) lines.push(`${type}: ${count}`);
              }

              return lines;
            },
          },
        },
        zoom: {
          pan: {
            enabled: true,
            mode: 'x',
          },
          zoom: {
            wheel: {
              enabled: true,
            },
            pinch: {
              enabled: true,
            },
            mode: 'x',
          },
        },
      },
    },
  });

  // 2. Wykres: Liczebność faz badań
  const multilinePhaseLabels = chartData.phaseLabels.map((label) => {
    if (label && label.includes('Wczesna')) return ['Wczesna', 'faza 1'];

    return label;
  });

  new Chart(document.getElementById('phaseChart'), {
    type: 'bar',
    data: {
      labels: multilinePhaseLabels,
      datasets: [
        {
          label: 'Liczba badań',
          data: chartData.phaseValues,
          backgroundColor: getColor('--primary-color'),
          borderRadius: 4,
        },
      ],
    },
    options: {
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: function (context) {
              let label = context[0].label;

              if (Array.isArray(label)) {
                return label.join(' ');
              }
              if (typeof label === 'string') {
                return label.replace(',', ' ');
              }

              return label;
            },
          },
        },
      },
    },
  });

  // 3. Wykres: Wielkość grup badawczych
  new Chart(document.getElementById('enrollmentChart'), {
    type: 'doughnut',
    data: {
      labels: chartData.enrollmentLabels,
      datasets: [
        {
          // label: 'Liczba grup badawczych',
          data: chartData.enrollmentValues,
          backgroundColor: [
            getColor('--color-info'),
            getColor('--color-warning'),
            getColor('--color-success'),
          ],
          borderWidth: 0,
          hoverOffset: 4,
        },
      ],
    },
    options: {
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
          },
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              const label = context.label || '';
              const value = context.raw || 0;

              const dataset = context.dataset;
              const total = dataset.data.reduce((acc, curr) => acc + curr, 0);
              const percentage = ((value / total) * 100).toFixed(2);

              return `Liczba grup badawczych: ${value} (${percentage}%)`;
            },
          },
        },
      },
    },
  });

  // 4. Wykres: Najczęściej badane schorzenia
  window.conditionsChart = new Chart(
    document.getElementById('conditionsChart'),
    {
      type: 'bar',
      data: {
        labels: chartData.conditionsLabels,
        datasets: [
          {
            label: 'Liczba badań',
            data: chartData.conditionsValues,
            backgroundColor: getColor('--primary-color'),
            borderRadius: 4,
          },
        ],
      },
      options: {
        indexAxis: 'y',
        maintainAspectRatio: false,
        scales: {
          x: { beginAtZero: true },
          y: {
            ticks: {
              autoSkip: false,
              font: { size: 11 },
            },
          },
        },
        plugins: {
          legend: { display: false },
        },
      },
    },
  );

  function translateConditions(btn) {
    const chart = window.conditionsChart;

    if (!chart) return;

    // PL -> EN
    if (btn.classList.contains('is-active')) {
      chart.data.labels = JSON.parse(btn.dataset.original);
      chart.update();

      btn.classList.remove('is-active');
      btn.dataset.state = 'original';
      return;
    }

    // EN -> PL
    if (btn.dataset.cached) {
      chart.data.labels = JSON.parse(btn.dataset.cached);
      chart.update();

      btn.classList.add('is-active');
      btn.dataset.state = 'translated';
      return;
    }

    const labels = chart.data.labels;

    if (!btn.dataset.original) {
      btn.dataset.original = JSON.stringify(labels);
    }

    const batch = {};
    labels.forEach((label, index) => {
      batch[`l_${index}`] = label;
    });

    btn.classList.add('is-loading');

    fetch('/translate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ batch: batch }),
    })
      .then((r) => r.json())
      .then((data) => {
        btn.classList.remove('is-loading');

        if (data.translated_batch) {
          const newLabels = labels.map(
            (_, index) => data.translated_batch[`l_${index}`] || labels[index],
          );

          btn.dataset.cached = JSON.stringify(newLabels);

          chart.data.labels = newLabels;
          chart.update();

          btn.classList.add('is-active');
          btn.dataset.state = 'translated';
        }
      })
      .catch((err) => {
        console.error(err);
        btn.classList.remove('is-loading');
        alert('Nie udało się przetłumaczyć wykresu.');
      });
  }
</script>
{% endblock %}
